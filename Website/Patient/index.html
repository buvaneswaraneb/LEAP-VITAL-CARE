<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vital Care System</title>

  <!-- ‚úÖ Browser tab icon -->
  <link rel="icon" type="image/svg+xml" href="header.svg">

  <link href="https://fonts.googleapis.com/css2?family=Gaegu&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Gaegu', cursive;
      background-color: #9ABCC7;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      max-width: 400px;
      text-align: center;
      position: relative;
    }

    .page {
      display: none;
      background: #9ABCC7;
      padding: 20px;
      border-radius: 20px;
    }

    .page.active {
      display: block;
    }

    h1 {
      font-size: 48px;
      margin-bottom: 30px;
      color: #2c3e50;
    }

    .label {
      font-size: 24px;
      margin: 15px 0 8px 0;
      color: #2c3e50;
      text-align: left;
    }

    .name-section {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .name-section .label {
      margin: 0;
      font-size: 28px;
    }

    input {
      font-family: 'Gaegu', cursive;
      font-size: 22px;
      padding: 12px;
      width: 100%;
      border: none;
      border-radius: 8px;
      background-color: #D4D4D4;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .patient-name {
      font-size: 28px;
      color: #2c3e50;
      margin: 0;
    }

    .chart-container {
      background-color: #D4D4D4;
      border-radius: 8px;
      padding: 20px;
      margin: 15px 0;
      position: relative;
      height: 150px;
    }

    .current-value {
      position: absolute;
      top: 10px;
      right: 15px;
      font-size: 20px;
      color: #2c3e50;
      font-weight: bold;
    }

    canvas {
      width: 100%;
      height: 100%;
    }

    .photo-placeholder {
      background-color: #D4D4D4;
      border-radius: 8px;
      padding: 20px;
      margin: 30px 0;
      min-height: 300px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .photo-placeholder img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }

    .placeholder-text {
      font-size: 24px;
      color: #888;
    }

    .buttons {
      display: flex;
      gap: 15px;
      margin-top: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      font-family: 'Gaegu', cursive;
      font-size: 28px;
      padding: 15px 35px;
      background-color: #D4D4D4;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: #2c3e50;
      transition: transform 0.1s;
    }

    button:hover {
      transform: scale(1.05);
    }

    button:active {
      transform: scale(0.95);
    }

    .section-title {
      font-size: 32px;
      margin-top: 25px;
      margin-bottom: 15px;
      color: #2c3e50;
    }

    .link-text {
      margin-top: 20px;
      font-size: 20px;
      color: #2c3e50;
      cursor: pointer;
      text-decoration: underline;
    }

    .error {
      color: #e74c3c;
      font-size: 20px;
      margin: 10px 0;
    }

    .location-placeholder {
      background-color: #D4D4D4;
      border-radius: 8px;
      padding: 20px;
      margin: 30px 0;
      min-height: 500px;
      height: 70vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    .location-placeholder h2 {
      font-size: 36px;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .location-placeholder p {
      font-size: 24px;
      color: #666;
      text-align: center;
    }

    .map-container {
      width: 100%;
      height: 100%;
      flex: 1;
      border-radius: 8px;
      overflow: hidden;
      position: relative;
    }

    .map-container iframe {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 8px;
    }

    .map-controls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 10px;
      z-index: 10;
    }

    .map-control-btn {
      background-color: white;
      border: 2px solid #2c3e50;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 16px;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: all 0.2s;
    }

    .map-control-btn:hover {
      background-color: #3498db;
      color: white;
      transform: scale(1.05);
    }

    .fullscreen-map {
      position: fixed !important;
      top: 0;
      left: 0;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 9999;
      margin: 0;
      border-radius: 0 !important;
      max-width: none !important;
    }

    .fullscreen-backdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0,0,0,0.9);
      z-index: 9998;
    }

    .close-fullscreen-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 10000;
      background-color: #e74c3c;
      color: white;
      border: none;
      padding: 12px 24px;
      font-size: 20px;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }

    .close-fullscreen-btn:hover {
      background-color: #c0392b;
    }

    .location-info {
      margin-top: 15px;
      font-size: 18px;
      color: #2c3e50;
      text-align: center;
    }

    .location-info.loading {
      color: #95a5a6;
    }

    .location-info.error {
      color: #e74c3c;
    }

    .refresh-location-btn {
      margin-top: 15px;
      font-size: 20px;
      padding: 10px 25px;
      background-color: #3498db;
      color: white;
    }

    .refresh-location-btn:hover {
      background-color: #2980b9;
    }

    .logout-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 20px;
      padding: 8px 20px;
      background-color: #e74c3c;
      color: white;
    }

    .logout-btn:hover {
      background-color: #c0392b;
    }

    .connection-status {
      font-size: 18px;
      color: #666;
      margin-top: 10px;
    }

    .connection-status.connected {
      color: #27ae60;
    }

    .connection-status.disconnected {
      color: #e74c3c;
    }

    /* Alert Popup Styles */
    .alert-popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      border-radius: 12px;
      padding: 40px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
      z-index: 10001;
      animation: alertSlideIn 0.4s ease-out;
    }

    .alert-popup.active {
      display: block;
    }

    @keyframes alertSlideIn {
      from {
        transform: translate(-50%, -60%);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%);
        opacity: 1;
      }
    }

    .alert-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.7);
      z-index: 10000;
    }

    .alert-backdrop.active {
      display: block;
    }

    .alert-icon {
      font-size: 80px;
      text-align: center;
      margin-bottom: 20px;
    }

    .alert-title {
      font-size: 36px;
      color: #2c3e50;
      text-align: center;
      margin-bottom: 15px;
      font-weight: bold;
    }

    .alert-message {
      font-size: 24px;
      color: #555;
      text-align: center;
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .alert-location {
      background-color: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
    }

    .alert-location-text {
      font-size: 18px;
      color: #2c3e50;
      margin: 5px 0;
    }

    .alert-buttons {
      display: flex;
      gap: 15px;
      justify-content: center;
    }

    .alert-btn {
      font-family: 'Gaegu', cursive;
      font-size: 24px;
      padding: 15px 35px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .alert-btn-primary {
      background-color: #3498db;
      color: white;
    }

    .alert-btn-primary:hover {
      background-color: #2980b9;
      transform: scale(1.05);
    }

    .alert-btn-danger {
      background-color: #e74c3c;
      color: white;
    }

    .alert-btn-danger:hover {
      background-color: #c0392b;
      transform: scale(1.05);
    }

    .alert-distress {
      border: 4px solid #f39c12;
    }

    .alert-help {
      border: 4px solid #e74c3c;
    }

    /* Notification Badge */
    .notification-badge {
      position: fixed;
      top: 20px;
      right: 20px;
      background-color: #e74c3c;
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      font-size: 20px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      animation: slideInRight 0.5s ease-out;
      cursor: pointer;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .notification-badge:hover {
      background-color: #c0392b;
      transform: scale(1.05);
    }

    /* AI Report Styles */
    .ai-report-container {
      background-color: #D4D4D4;
      border-radius: 8px;
      padding: 30px 20px;
      margin: 30px 0;
      min-height: 400px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .ai-report-title {
      font-size: 32px;
      color: #2c3e50;
      margin-bottom: 30px;
      text-align: center;
    }

    .ai-report-status {
      font-size: 28px;
      color: #2c3e50;
      margin: 20px 0;
      text-align: center;
      line-height: 1.5;
    }

    .status-badge {
      display: inline-block;
      padding: 15px 40px;
      border-radius: 50px;
      font-size: 28px;
      font-weight: bold;
      margin-top: 20px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .status-normal {
      background-color: #4CAF50;
      color: white;
    }

    .status-warning {
      background-color: #FFC107;
      color: #2c3e50;
    }

    .status-emergency {
      background-color: #f44336;
      color: white;
    }

    .ai-button {
      font-family: 'Gaegu', cursive;
      font-size: 28px;
      padding: 15px 35px;
      background-color: #2c3e50;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      color: white;
      margin-top: 30px;
      transition: all 0.2s;
    }

    .ai-button:hover {
      background-color: #34495e;
      transform: scale(1.05);
    }

    .health-metrics {
      display: flex;
      gap: 20px;
      margin: 20px 0;
      width: 100%;
      justify-content: center;
    }

    .metric-box {
      background-color: #D4D4D4;
      padding: 15px 20px;
      border-radius: 8px;
      flex: 1;
      max-width: 150px;
    }

    .metric-label {
      font-size: 18px;
      color: #666;
      margin-bottom: 5px;
    }

    .metric-value {
      font-size: 32px;
      color: #2c3e50;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- LOGIN PAGE -->
    <div id="loginPage" class="page active">
      <h1>Vital Care</h1>
      <div class="label">Username:</div>
      <input type="text" id="loginUsername" placeholder="Enter username">
      
      <div class="label">Date of Birth:</div>
      <input type="date" id="loginDOB">
      
      <div class="error" id="loginError"></div>
      
      <div class="buttons">
        <button onclick="login()">Login</button>
      </div>
      
      <div class="link-text" onclick="showPage('signupPage')">Don't have an account? Sign Up</div>
    </div>

    <!-- SIGNUP PAGE -->
    <div id="signupPage" class="page">
      <h1>Sign Up</h1>
      
      <div class="label">Name:</div>
      <input type="text" id="signupName" placeholder="Patient's full name">
      
      <div class="label">Age:</div>
      <input type="number" id="signupAge" placeholder="Age">
      
      <div class="label">Date of Birth:</div>
      <input type="date" id="signupDOB">
      
      <div class="label">Username:</div>
      <input type="text" id="signupUsername" placeholder="Choose username">
      
      <div class="error" id="signupError"></div>
      
      <div class="buttons">
        <button onclick="signup()">Sign Up</button>
      </div>
      
      <div class="link-text" onclick="showPage('loginPage')">Already have an account? Login</div>
    </div>

    <!-- AI REPORT PAGE -->
    <div id="cameraPage" class="page">
      <button class="logout-btn" onclick="logout()">Logout</button>
      <h1>Ai Report</h1>
      
      <div class="name-section">
        <div class="label">Patients Name:</div>
        <div class="patient-name" id="cameraPatientName">Patient Name</div>
      </div>
      
      <div class="ai-report-container">
        <div class="ai-report-title">AI Report</div>
        
        <div class="health-metrics">
          <div class="metric-box">
            <div class="metric-label">Temp</div>
            <div class="metric-value" id="aiTempValue">--</div>
          </div>
          <div class="metric-box">
            <div class="metric-label">BPM</div>
            <div class="metric-value" id="aiBpmValue">--</div>
          </div>
        </div>
        
        <div class="ai-report-status" id="aiReportStatus">
          The patient<br>is normal<br>no abnormalities
        </div>
        
        <div class="status-badge" id="statusBadge">Normal</div>
        
        <button class="ai-button" onclick="refreshAIReport()">AI</button>
      </div>
      
      <div class="buttons">
        <button onclick="showPage('locationPage')">locate</button>
        <button onclick="showPage('statsPage')">stats</button>
      </div>
    </div>

    <!-- VITAL CARE (STATS) PAGE -->
    <div id="statsPage" class="page">
      <button class="logout-btn" onclick="logout()">Logout</button>
      <h1>Vital Care</h1>
      
      <div class="name-section">
        <div class="label">Patients Name:</div>
        <div class="patient-name" id="statsPatientName">Patient Name</div>
      </div>
      
      <div class="connection-status" id="connectionStatus">Connecting...</div>
      
      <div class="chart-container">
        <div class="current-value" id="tempValue">curr Temp: --</div>
        <canvas id="tempChart"></canvas>
      </div>
      <div class="section-title">Patients temperature</div>
      
      <div class="chart-container">
        <div class="current-value" id="pulseValue">curr pulse: --</div>
        <canvas id="pulseChart"></canvas>
      </div>
      <div class="section-title">Patients pulse</div>
      
      <div class="buttons">
        <button onclick="showPage('locationPage')">locate</button>
        <button onclick="showPage('cameraPage')">AI</button>
      </div>
    </div>

    <!-- LOCATION PAGE -->
    <div id="locationPage" class="page">
      <button class="logout-btn" onclick="logout()">Logout</button>
      <h1>Lokation</h1>
      
      <div class="name-section">
        <div class="label">Patients Name:</div>
        <div class="patient-name" id="locationPatientName">Patient Name</div>
      </div>
      
      <div class="location-placeholder" id="locationPlaceholder">
        <div class="map-container" id="mapContainer">
          <h2>Loading Location...</h2>
          <p>Fetching patient location from server</p>
        </div>
      </div>
      
      <div class="location-info" id="locationInfo">
        üìç Waiting for location data...
      </div>
      
      <div class="buttons">
        <button class="refresh-location-btn" onclick="refreshLocation()">üîÑ Refresh</button>
      </div>
      
      <div class="buttons">
        <button onclick="showPage('cameraPage')">AI</button>
        <button onclick="showPage('statsPage')">stats</button>
      </div>
    </div>
  </div>

  <!-- Alert Popup -->
  <div class="alert-backdrop" id="alertBackdrop" onclick="dismissAlert()"></div>
  <div class="alert-popup" id="alertPopup">
    <div class="alert-icon" id="alertIcon">üö®</div>
    <div class="alert-title" id="alertTitle">Emergency Alert</div>
    <div class="alert-message" id="alertMessage">Patient needs assistance!</div>
    <div class="alert-location">
      <div class="alert-location-text" id="alertLocationText">üìç Location unavailable</div>
      <div class="alert-location-text" id="alertPatientName"></div>
    </div>
    <div class="alert-buttons">
      <button class="alert-btn alert-btn-primary" onclick="viewLocation()">View Map</button>
      <button class="alert-btn alert-btn-danger" onclick="dismissAlert()">Dismiss</button>
    </div>
  </div>

  <script>
    // Data storage (using variables instead of localStorage)
    let currentUser = null;
    let tempData = [];
    let pulseData = [];
    const MAX_DATA_POINTS = 20;
    let updateInterval = null;
    let savedUsers = {
      // Test admin account
      'admin': {
        name: 'Admin User',
        age: '30',
        dob: '1111-11-11',
        username: 'admin'
      }
    }; // Store user accounts
    let savedPhotos = {}; // Store photos
    
    // Alert monitoring
    let alertCheckInterval = null;
    let lastAlertState = null; // Changed to null to indicate uninitialized
    let lastAlertLocation = { latitude: null, longitude: null };
    let isFirstAlertCheck = true; // Track if this is the first check
    let currentAlertType = null; // Track current alert type for acknowledgment

    // Check for user alerts
    async function checkUserAlerts() {
      const API_URL = 'https://nonsignificantly-bilgier-particia.ngrok-free.dev/api/usr/status';
      
      try {
        const response = await fetch(API_URL, {
          method: 'GET',
          headers: {
            'ngrok-skip-browser-warning': 'true'
          },
          cache: 'no-cache'
        });

        if (!response.ok) return;

        const data = await response.json();
        
        // Check if there's a new alert
        if (data.state && data.location) {
          // On first check, just initialize the state without showing alerts
          if (isFirstAlertCheck) {
            lastAlertState = { ...data.state };
            lastAlertLocation = { ...data.location };
            isFirstAlertCheck = false;
            console.log('Alert monitoring initialized with state:', lastAlertState);
            return; // Exit without showing any alerts
          }
          
          // Check for NEW alerts (state changed from false to true)
          const isNewDistress = data.state.distress && !lastAlertState.distress;
          const isNewHelp = data.state.help && !lastAlertState.help;
          
          if (isNewDistress || isNewHelp) {
            // Store current state
            lastAlertState = { ...data.state };
            lastAlertLocation = { ...data.location };
            
            // Show alert popup
            showAlert(
              isNewDistress ? 'distress' : 'help',
              data.location.latitude,
              data.location.longitude
            );
            
            // Play alert sound (optional)
            playAlertSound();
          } else {
            // Update state for next check
            lastAlertState = { ...data.state };
          }
        }
      } catch (error) {
        console.error('Error checking alerts:', error);
      }
    }

    // Show alert popup
    function showAlert(type, latitude, longitude) {
      const backdrop = document.getElementById('alertBackdrop');
      const popup = document.getElementById('alertPopup');
      const icon = document.getElementById('alertIcon');
      const title = document.getElementById('alertTitle');
      const message = document.getElementById('alertMessage');
      const locationText = document.getElementById('alertLocationText');
      const patientName = document.getElementById('alertPatientName');
      
      // Store current alert type for acknowledgment
      currentAlertType = type;
      
      // Configure alert based on type
      if (type === 'distress') {
        icon.textContent = '‚ö†Ô∏è';
        title.textContent = 'üö® DISTRESS SIGNAL';
        message.textContent = 'Patient is in distress and needs immediate assistance!';
        popup.classList.add('alert-distress');
        popup.classList.remove('alert-help');
      } else if (type === 'help') {
        icon.textContent = 'üÜò';
        title.textContent = 'üÜò HELP REQUESTED';
        message.textContent = 'Patient has requested help and assistance.';
        popup.classList.add('alert-help');
        popup.classList.remove('alert-distress');
      }
      
      // Set location
      if (latitude && longitude) {
        locationText.textContent = `üìç Location: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
      } else {
        locationText.textContent = 'üìç Location: Not available';
      }
      
      // Set patient name if available
      if (currentUser) {
        patientName.textContent = `Patient: ${currentUser.name}`;
      } else {
        patientName.textContent = '';
      }
      
      // Show popup
      backdrop.classList.add('active');
      popup.classList.add('active');
    }

    // Close alert popup (without acknowledging)
    function closeAlert() {
      const backdrop = document.getElementById('alertBackdrop');
      const popup = document.getElementById('alertPopup');
      
      backdrop.classList.remove('active');
      popup.classList.remove('active');
    }

    // Dismiss alert (acknowledges and clears it)
    async function dismissAlert() {
      if (!currentAlertType) {
        closeAlert();
        return;
      }
      
      const API_URL = 'https://nonsignificantly-bilgier-particia.ngrok-free.dev/api/usr/acknowledge';
      
      try {
        const acknowledgment = {};
        if (currentAlertType === 'distress') {
          acknowledgment.distress_ack = true;
        } else if (currentAlertType === 'help') {
          acknowledgment.help_ack = true;
        }
        
        const response = await fetch(API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'ngrok-skip-browser-warning': 'true'
          },
          body: JSON.stringify(acknowledgment)
        });
        
        if (response.ok) {
          const data = await response.json();
          console.log('‚úÖ Alert acknowledged and dismissed:', data);
          
          // Reset the last alert state to prevent re-triggering
          if (lastAlertState) {
            if (currentAlertType === 'distress') {
              lastAlertState.distress = false;
            } else if (currentAlertType === 'help') {
              lastAlertState.help = false;
            }
          }
          
          // Close the alert popup
          closeAlert();
          currentAlertType = null;
        } else {
          console.error('Failed to acknowledge alert');
          closeAlert(); // Still close the popup even if acknowledgment fails
        }
      } catch (error) {
        console.error('Error acknowledging alert:', error);
        closeAlert(); // Still close the popup even if there's an error
      }
    }

    // View location from alert (acknowledges and goes to map)
    async function viewLocation() {
      // First acknowledge the alert
      if (currentAlertType) {
        const API_URL = 'https://nonsignificantly-bilgier-particia.ngrok-free.dev/api/usr/acknowledge';
        
        try {
          const acknowledgment = {};
          if (currentAlertType === 'distress') {
            acknowledgment.distress_ack = true;
          } else if (currentAlertType === 'help') {
            acknowledgment.help_ack = true;
          }
          
          await fetch(API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'ngrok-skip-browser-warning': 'true'
            },
            body: JSON.stringify(acknowledgment)
          });
          
          console.log('‚úÖ Alert acknowledged via View Map');
          
          // Reset the last alert state
          if (lastAlertState) {
            if (currentAlertType === 'distress') {
              lastAlertState.distress = false;
            } else if (currentAlertType === 'help') {
              lastAlertState.help = false;
            }
          }
          
          currentAlertType = null;
        } catch (error) {
          console.error('Error acknowledging alert:', error);
        }
      }
      
      closeAlert();
      showPage('locationPage');
    }

    // Play alert sound (optional)
    function playAlertSound() {
      // Create a simple beep sound
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioContext.createOscillator();
      const gainNode = audioContext.createGain();
      
      oscillator.connect(gainNode);
      gainNode.connect(audioContext.destination);
      
      oscillator.frequency.value = 800;
      oscillator.type = 'sine';
      
      gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
      gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
      
      oscillator.start(audioContext.currentTime);
      oscillator.stop(audioContext.currentTime + 0.5);
    }

    // Start alert monitoring
    function startAlertMonitoring() {
      if (alertCheckInterval) return;
      
      // Reset first check flag when starting monitoring
      isFirstAlertCheck = true;
      
      // Check every 1 second as requested
      alertCheckInterval = setInterval(checkUserAlerts, 1000);
      checkUserAlerts(); // Check immediately (will initialize state)
    }

    // Stop alert monitoring
    function stopAlertMonitoring() {
      if (alertCheckInterval) {
        clearInterval(alertCheckInterval);
        alertCheckInterval = null;
      }
      // Reset state when stopping
      lastAlertState = null;
      isFirstAlertCheck = true;
    }

    // Page navigation
    function showPage(pageId) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(pageId).classList.add('active');
      
      if (pageId === 'statsPage') {
        startDataUpdates();
        stopAIReportUpdates();
      } else if (pageId === 'cameraPage') {
        stopDataUpdates();
        startAIReportUpdates();
      } else {
        stopDataUpdates();
        stopAIReportUpdates();
      }
    }

    // Sign up
    function signup() {
      const name = document.getElementById('signupName').value.trim();
      const age = document.getElementById('signupAge').value.trim();
      const dob = document.getElementById('signupDOB').value;
      const username = document.getElementById('signupUsername').value.trim();
      
      if (!name || !age || !dob || !username) {
        document.getElementById('signupError').textContent = 'Please fill all fields';
        return;
      }
      
      const userData = { name, age, dob, username };
      savedUsers[username] = userData;
      currentUser = userData;
      
      document.getElementById('signupError').textContent = '';
      loadUserSession();
    }

    // Login
    function login() {
      const username = document.getElementById('loginUsername').value.trim();
      const dob = document.getElementById('loginDOB').value;
      
      if (!username || !dob) {
        document.getElementById('loginError').textContent = 'Please enter username and DOB';
        return;
      }
      
      if (!savedUsers[username]) {
        document.getElementById('loginError').textContent = 'No account found. Please sign up first.';
        return;
      }
      
      const userData = savedUsers[username];
      if (userData.dob === dob) {
        currentUser = userData;
        document.getElementById('loginError').textContent = '';
        loadUserSession();
      } else {
        document.getElementById('loginError').textContent = 'Invalid username or date of birth';
      }
    }

    // Load user session
    function loadUserSession() {
      document.getElementById('cameraPatientName').textContent = currentUser.name;
      document.getElementById('statsPatientName').textContent = currentUser.name;
      document.getElementById('locationPatientName').textContent = currentUser.name;
      
      // Start monitoring for alerts
      startAlertMonitoring();
      
      // Start AI report updates
      startAIReportUpdates();
      
      showPage('cameraPage');
    }

    // ===============================
    // AI REPORT FUNCTIONS
    // ===============================
    let aiReportInterval = null;
    let lastTemperature = 0;
    let lastBPM = 0;

    // Analyze health status based on temperature and BPM
    function analyzeHealthStatus(temperature, bpm) {
      const statusElement = document.getElementById('statusBadge');
      const reportElement = document.getElementById('aiReportStatus');
      
      // Remove all status classes
      statusElement.classList.remove('status-normal', 'status-warning', 'status-emergency');
      
      // Normal ranges: Temperature 36.1-37.2¬∞C, BPM 60-100
      const tempNormal = temperature >= 36.1 && temperature <= 37.2;
      const bpmNormal = bpm >= 60 && bpm <= 100;
      
      // Warning ranges: Temperature 35-36 or 37.3-38¬∞C, BPM 50-59 or 101-120
      const tempWarning = (temperature >= 35 && temperature < 36.1) || 
                          (temperature > 37.2 && temperature <= 38);
      const bpmWarning = (bpm >= 50 && bpm < 60) || (bpm > 100 && bpm <= 120);
      
      // Emergency: Temperature <35 or >38¬∞C, BPM <50 or >120
      const tempEmergency = temperature < 35 || temperature > 38;
      const bpmEmergency = bpm < 50 || bpm > 120;
      
      if (tempEmergency || bpmEmergency) {
        // Emergency status
        statusElement.textContent = 'Emergency';
        statusElement.classList.add('status-emergency');
        
        let issues = [];
        if (tempEmergency) {
          if (temperature < 35) issues.push('critically low temperature');
          else issues.push('critically high temperature');
        }
        if (bpmEmergency) {
          if (bpm < 50) issues.push('critically low heart rate');
          else issues.push('critically high heart rate');
        }
        
        reportElement.innerHTML = `The patient<br>requires immediate attention<br>${issues.join(' and ')}`;
        
      } else if (tempWarning || bpmWarning) {
        // Warning status
        statusElement.textContent = 'Attention';
        statusElement.classList.add('status-warning');
        
        let concerns = [];
        if (tempWarning) {
          if (temperature < 36.1) concerns.push('slightly low temperature');
          else concerns.push('slightly elevated temperature');
        }
        if (bpmWarning) {
          if (bpm < 60) concerns.push('slightly low heart rate');
          else concerns.push('slightly elevated heart rate');
        }
        
        reportElement.innerHTML = `The patient<br>needs monitoring<br>${concerns.join(' and ')}`;
        
      } else if (tempNormal && bpmNormal) {
        // Normal status
        statusElement.textContent = 'Normal';
        statusElement.classList.add('status-normal');
        reportElement.innerHTML = 'The patient<br>is normal<br>no abnormalities';
      } else {
        // Unknown/No data
        statusElement.textContent = 'Unknown';
        statusElement.classList.add('status-warning');
        reportElement.innerHTML = 'The patient<br>status unknown<br>checking vitals...';
      }
    }

    // Fetch and update AI report
    async function updateAIReport() {
      if (!currentUser) return;
      
      const API_URL = 'https://nonsignificantly-bilgier-particia.ngrok-free.dev/api/data';
      
      try {
        const response = await fetch(API_URL, {
          method: 'GET',
          headers: {
            'ngrok-skip-browser-warning': 'true'
          },
          cache: 'no-cache'
        });
        
        const data = await response.json();
        
        lastTemperature = data.temperature;
        lastBPM = data.bpm;
        
        // Update display
        document.getElementById('aiTempValue').textContent = `${data.temperature.toFixed(1)}¬∞C`;
        document.getElementById('aiBpmValue').textContent = data.bpm;
        
        // Analyze and update status
        analyzeHealthStatus(data.temperature, data.bpm);
        
      } catch (error) {
        console.error('Error fetching AI report data:', error);
        document.getElementById('aiTempValue').textContent = '--';
        document.getElementById('aiBpmValue').textContent = '--';
      }
    }

    // Start AI report updates
    function startAIReportUpdates() {
      if (aiReportInterval) return;
      
      // Update every 3 seconds
      aiReportInterval = setInterval(updateAIReport, 3000);
      updateAIReport(); // Update immediately
    }

    // Stop AI report updates
    function stopAIReportUpdates() {
      if (aiReportInterval) {
        clearInterval(aiReportInterval);
        aiReportInterval = null;
      }
    }

    // Refresh AI report manually
    function refreshAIReport() {
      updateAIReport();
    }


    // Setup canvases
    const tempCanvas = document.getElementById('tempChart');
    const pulseCanvas = document.getElementById('pulseChart');
    const tempCtx = tempCanvas.getContext('2d');
    const pulseCtx = pulseCanvas.getContext('2d');

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      
      // Resize temp canvas
      const tempRect = tempCanvas.getBoundingClientRect();
      tempCanvas.width = tempRect.width * dpr;
      tempCanvas.height = tempRect.height * dpr;
      tempCtx.scale(dpr, dpr);
      
      // Resize pulse canvas
      const pulseRect = pulseCanvas.getBoundingClientRect();
      pulseCanvas.width = pulseRect.width * dpr;
      pulseCanvas.height = pulseRect.height * dpr;
      pulseCtx.scale(dpr, dpr);
      
      // Redraw charts
      if (tempData.length > 0) {
        drawChart(tempCtx, tempData, tempCanvas);
      }
      if (pulseData.length > 0) {
        drawChart(pulseCtx, pulseData, pulseCanvas);
      }
    }
    
    // Wait for canvas to be visible before resizing
    setTimeout(resizeCanvas, 100);
    window.addEventListener('resize', resizeCanvas);

    // Draw chart
    function drawChart(ctx, data, canvas) {
      const rect = canvas.getBoundingClientRect();
      const width = rect.width;
      const height = rect.height;
      
      ctx.clearRect(0, 0, width, height);
      
      if (data.length < 2) return;

      ctx.strokeStyle = '#2c3e50';
      ctx.lineWidth = 3;
      ctx.lineCap = 'round';
      ctx.lineJoin = 'round';
      ctx.beginPath();

      const padding = 20;
      const chartWidth = width - padding * 2;
      const chartHeight = height - padding * 2;
      const stepX = chartWidth / (MAX_DATA_POINTS - 1);

      // Filter out invalid values
      const validData = data.filter(v => v !== null && v !== undefined && !isNaN(v) && v > -100);
      
      if (validData.length < 2) return;

      const min = Math.min(...validData);
      const max = Math.max(...validData);
      const range = max - min || 1;

      let firstPoint = true;
      data.forEach((value, index) => {
        if (value === null || value === undefined || isNaN(value) || value <= -100) {
          return;
        }
        
        const x = padding + index * stepX;
        const y = height - padding - ((value - min) / range) * chartHeight;
        
        if (firstPoint) {
          ctx.moveTo(x, y);
          firstPoint = false;
        } else {
          ctx.lineTo(x, y);
        }
      });

      ctx.stroke();
      
      // Draw points
      ctx.fillStyle = '#2c3e50';
      data.forEach((value, index) => {
        if (value === null || value === undefined || isNaN(value) || value <= -100) {
          return;
        }
        
        const x = padding + index * stepX;
        const y = height - padding - ((value - min) / range) * chartHeight;
        
        ctx.beginPath();
        ctx.arc(x, y, 4, 0, Math.PI * 2);
        ctx.fill();
      });
    }

    // Fetch data from ngrok API
async function fetchData() {
  if (!currentUser) return;

  const statusEl = document.getElementById('connectionStatus');
  const API_URL = 'https://nonsignificantly-bilgier-particia.ngrok-free.dev/api/data';

  try {
    const response = await fetch(API_URL, {
      method: 'GET',
      headers: {
        'ngrok-skip-browser-warning': 'true'
      },
      cache: 'no-cache'
    });

    const data = await response.json();

    statusEl.textContent = 'Connected ‚úì';
    statusEl.className = 'connection-status connected';

    document.getElementById('tempValue').textContent =
      `curr Temp: ${data.temperature.toFixed(1)}¬∞C`;

    document.getElementById('pulseValue').textContent =
      `curr pulse: ${data.bpm} BPM`;

    if (data.temperature > -100 && data.temperature < 100)
      tempData.push(data.temperature);

    if (data.bpm >= 0 && data.bpm < 300)
      pulseData.push(data.bpm);

    if (tempData.length > MAX_DATA_POINTS) tempData.shift();
    if (pulseData.length > MAX_DATA_POINTS) pulseData.shift();

    drawChart(tempCtx, tempData, tempCanvas);
    drawChart(pulseCtx, pulseData, pulseCanvas);

  } catch (error) {
    console.error('Error fetching data:', error);
    statusEl.textContent = 'Disconnected ‚úó';
    statusEl.className = 'connection-status disconnected';
  }
}
    function startDataUpdates() {
      if (updateInterval) return;
      
      // Clear old data when starting fresh
      tempData = [];
      pulseData = [];
      
      // Resize canvases
      setTimeout(resizeCanvas, 100);
      
      updateInterval = setInterval(fetchData, 2000);
      fetchData(); // Fetch immediately
    }

    function stopDataUpdates() {
      if (updateInterval) {
        clearInterval(updateInterval);
        updateInterval = null;
      }
    }

    // Logout function
    function logout() {
      stopDataUpdates();
      stopAlertMonitoring();
      stopAIReportUpdates();
      currentUser = null;
      tempData = [];
      pulseData = [];
      
      // Clear login form
      document.getElementById('loginUsername').value = '';
      document.getElementById('loginDOB').value = '';
      document.getElementById('loginError').textContent = '';
      
      showPage('loginPage');
    }

    // ===============================
    // LOCATION PAGE FUNCTIONS
    // ===============================
    let locationUpdateInterval = null;
    let currentLatitude = null;
    let currentLongitude = null;
    let lastDisplayedLat = null;
    let lastDisplayedLon = null;

    // Fetch user location from API
    async function fetchUserLocation() {
      const API_URL = 'https://nonsignificantly-bilgier-particia.ngrok-free.dev/api/usr/status';
      const locationInfo = document.getElementById('locationInfo');
      const mapContainer = document.getElementById('mapContainer');

      try {
        const response = await fetch(API_URL, {
          method: 'GET',
          headers: {
            'ngrok-skip-browser-warning': 'true'
          },
          cache: 'no-cache'
        });

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        
        if (data.location && data.location.latitude && data.location.longitude) {
          const lat = data.location.latitude;
          const lon = data.location.longitude;
          
          // Store current coordinates
          currentLatitude = lat;
          currentLongitude = lon;
          
          // Update location info
          locationInfo.textContent = `üìç Location: ${lat.toFixed(6)}, ${lon.toFixed(6)}`;
          locationInfo.className = 'location-info';

          // Only update map if location has changed significantly (more than 0.0001 degrees ~ 11 meters)
          const locationChanged = !lastDisplayedLat || !lastDisplayedLon ||
                                  Math.abs(lat - lastDisplayedLat) > 0.0001 ||
                                  Math.abs(lon - lastDisplayedLon) > 0.0001;
          
          if (locationChanged) {
            displayMap(lat, lon);
            lastDisplayedLat = lat;
            lastDisplayedLon = lon;
            console.log('Map updated with new location:', lat, lon);
          } else {
            console.log('Location unchanged, skipping map refresh');
          }
          
        } else {
          locationInfo.textContent = 'üìç No location data available yet';
          locationInfo.className = 'location-info error';
          
          // Only update if not already showing this message
          if (!mapContainer.querySelector('h2')?.textContent.includes('No Location Data')) {
            mapContainer.innerHTML = `
              <h2>No Location Data</h2>
              <p>Waiting for user to share location...</p>
            `;
          }
        }

      } catch (error) {
        console.error('Error fetching location:', error);
        locationInfo.textContent = 'üìç Error fetching location';
        locationInfo.className = 'location-info error';
        
        // Only update if not already showing error
        if (!mapContainer.querySelector('h2')?.textContent.includes('Connection Error')) {
          mapContainer.innerHTML = `
            <h2>Connection Error</h2>
            <p>Could not fetch location from server</p>
            <p style="font-size: 18px; margin-top: 10px;">Error: ${error.message}</p>
          `;
        }
      }
    }

    // Display Google Maps with marker
    function displayMap(lat, lon) {
      const mapContainer = document.getElementById('mapContainer');
      
      // Create Google Maps iframe embed with better zoom and controls
      const mapUrl = `https://www.google.com/maps?q=${lat},${lon}&z=16&output=embed`;
      
      mapContainer.innerHTML = `
        <iframe
          src="${mapUrl}"
          loading="lazy"
          allowfullscreen
          referrerpolicy="no-referrer-when-downgrade">
        </iframe>
      `;
    }

    // Toggle fullscreen map
    let isFullscreen = false;
    function toggleFullscreenMap() {
      const mapContainer = document.getElementById('mapContainer');
      const locationPlaceholder = document.getElementById('locationPlaceholder');
      
      if (!isFullscreen) {
        // Enter fullscreen
        isFullscreen = true;
        
        // Create backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'fullscreen-backdrop';
        backdrop.id = 'fullscreenBackdrop';
        document.body.appendChild(backdrop);
        
        // Create close button
        const closeBtn = document.createElement('button');
        closeBtn.className = 'close-fullscreen-btn';
        closeBtn.textContent = '‚úï Close';
        closeBtn.id = 'closeFullscreenBtn';
        closeBtn.onclick = toggleFullscreenMap;
        document.body.appendChild(closeBtn);
        
        // Make map fullscreen
        mapContainer.classList.add('fullscreen-map');
        
        // Prevent scrolling on body
        document.body.style.overflow = 'hidden';
      } else {
        // Exit fullscreen
        isFullscreen = false;
        
        // Remove backdrop
        const backdrop = document.getElementById('fullscreenBackdrop');
        if (backdrop) backdrop.remove();
        
        // Remove close button
        const closeBtn = document.getElementById('closeFullscreenBtn');
        if (closeBtn) closeBtn.remove();
        
        // Remove fullscreen class
        mapContainer.classList.remove('fullscreen-map');
        
        // Restore scrolling
        document.body.style.overflow = 'auto';
      }
    }

    // Open in Google Maps (new window)
    function openInGoogleMaps(lat, lon) {
      const url = `https://www.google.com/maps/search/?api=1&query=${lat},${lon}`;
      window.open(url, '_blank');
    }

    // Get directions to location
    function getDirections(lat, lon) {
      const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
      window.open(url, '_blank');
    }

    // Refresh location manually
    function refreshLocation() {
      // Force map update by resetting last displayed coordinates
      lastDisplayedLat = null;
      lastDisplayedLon = null;
      fetchUserLocation();
    }

    // Start location updates when location page is shown
    function startLocationUpdates() {
      if (locationUpdateInterval) {
        clearInterval(locationUpdateInterval);
      }
      
      // Fetch immediately
      fetchUserLocation();
      
      // Update every 10 seconds
      locationUpdateInterval = setInterval(fetchUserLocation, 10000);
    }

    // Stop location updates
    function stopLocationUpdates() {
      if (locationUpdateInterval) {
        clearInterval(locationUpdateInterval);
        locationUpdateInterval = null;
      }
    }

    // Update the showPage function to handle location updates
    const originalShowPage = showPage;
    showPage = function(pageId) {
      // Call original function
      originalShowPage(pageId);
      
      // Handle location page specifically
      if (pageId === 'locationPage') {
        startLocationUpdates();
      } else {
        stopLocationUpdates();
      }
    };
  </script>
</body>
</html> 